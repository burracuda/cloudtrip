<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take A Daytrip - Discography</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--background-color:#ffffff;--text-primary:#000000;--text-secondary:#666666;--font-main:"Poppins",sans-serif;--item-width:280px;--item-height:280px;--item-gap:30px;--border-color:#e0e0e0;--overlay-bg:rgba(255,255,255,0.85);--transition-speed:0.3s;--border-radius:12px}*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font-main);background-color:var(--background-color);color:var(--text-primary);overflow-x:hidden;line-height:1.4}#intro-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background-color:var(--background-color);z-index:9999;display:flex;align-items:center;justify-content:center;transition:opacity .8s cubic-bezier(.77,0,.175,1)}#intro-overlay.hidden{opacity:0;pointer-events:none}#intro-logo{width:40vw;max-width:400px;transition:transform 1s cubic-bezier(.77,0,.175,1)}#intro-overlay.hidden #intro-logo{transform:scale(.1)}.site-content{opacity:0;animation:fadeIn .5s ease-in-out 1.2s forwards}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.header{position:fixed;top:0;left:0;right:0;z-index:100;padding:20px 40px;display:flex;justify-content:space-between;align-items:center;background:var(--background-color);border-bottom:1px solid var(--border-color)}.logo img{height:45px;width:auto}.view-toggle{background:var(--background-color);border:1px solid var(--border-color);color:var(--text-primary);padding:8px 16px;border-radius:var(--border-radius);cursor:pointer;transition:all var(--transition-speed) ease;font-family:var(--font-main);font-size:14px;font-weight:500}.view-toggle:hover{background:var(--text-primary);color:var(--background-color);transform:translateY(-1px)}.carousel-view{min-height:100vh;display:flex;align-items:center;position:relative;padding-top:80px}.carousel-container{display:flex;overflow-x:auto;overflow-y:hidden;gap:var(--item-gap);padding:60px 40px;width:100%;scroll-behavior:smooth;-ms-overflow-style:none;scrollbar-width:none;-webkit-mask-image:linear-gradient(to right,transparent,black 5%,black 95%,transparent);mask-image:linear-gradient(to right,transparent,black 5%,black 95%,transparent)}
        .carousel-container::-webkit-scrollbar{display:none}
        .carousel-item{flex-shrink:0;width:var(--item-width);display:flex;flex-direction:column;cursor:pointer;transition:transform .3s cubic-bezier(.25,.8,.25,1),width .5s cubic-bezier(.77,0,.175,1);position:relative}
        .carousel-item:hover{transform:translateY(-4px) scale(1.05);z-index:10}
        .album-cover{width:100%;height:var(--item-height);background-color:#f0f0f0;background-size:cover;background-position:center;border-radius:var(--border-radius);margin-bottom:16px;transition:all var(--transition-speed) ease;box-shadow:0 4px 20px rgba(0,0,0,.08);position:relative;overflow:hidden}
        .album-cover video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .4s ease .2s}
        .action-overlay{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,0.8),transparent);display:flex;flex-direction:column;justify-content:flex-end;align-items:center;padding-bottom:20px;gap:10px;opacity:0;transition:opacity .4s ease;pointer-events:none}
        .action-overlay a{text-decoration:none;color:white;background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);padding:10px 24px;border-radius:20px;font-size:14px;font-weight:500;transform:translateY(10px);opacity:0;transition:opacity .3s ease,transform .3s ease}
        .action-overlay a:hover{background:rgba(255,255,255,0.25)}
        .carousel-item.is-active .action-overlay{opacity:1;pointer-events:auto}
        .carousel-item.is-active .action-overlay a{opacity:1;transform:translateY(0);transition-delay:0.2s}
        .carousel-item.is-active .action-overlay a:nth-child(2){transition-delay:.25s}
        .carousel-item.is-active .action-overlay a:nth-child(3){transition-delay:.3s}
        .carousel-item.is-expanded{width:calc(var(--item-height)*1.778)}
        .carousel-item.is-expanded .album-cover video{opacity:1}
        .item-info{text-align:left}.item-title{font-weight:600;font-size:16px;margin-bottom:4px;color:var(--text-primary)}.item-artist{font-weight:400;font-size:14px;color:var(--text-secondary)}
        .index-view{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--overlay-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:200;opacity:0;visibility:hidden;transition:opacity var(--transition-speed) ease, visibility 0s var(--transition-speed) linear;padding:100px 40px 40px;overflow-y:auto}
        .index-view.active{opacity:1;visibility:visible;transition-delay:0s}
        .index-grid{--grid-columns: 4; --thumbnail-size: 100px; display:grid; grid-template-columns:repeat(var(--grid-columns), 1fr); gap:20px;max-width:1400px;margin:0 auto; align-items: start;}
        .grid-item{background:#fff;border-radius:var(--border-radius);padding:16px;box-shadow:0 4px 20px rgba(0,0,0,.05);cursor:pointer; transition: transform 0.2s ease;}
        .grid-item:hover { transform: translateY(-2px); }
        .item-header{display:flex;align-items:center;gap:15px}
        .item-thumbnail{width:var(--thumbnail-size);height:var(--thumbnail-size);border-radius:8px;flex-shrink:0;background-color:#f0f0f0;background-size:cover;background-position:center; transition: width 0.3s ease, height 0.3s ease;}
        .item-details .title{font-weight:600;font-size:16px;color:var(--text-primary)}
        .item-details .artist{font-weight:400;color:var(--text-secondary);font-size:14px}
        .details-section{max-height:0;overflow:hidden;transition:max-height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);padding-top:0}
        .grid-item.is-album.is-expanded .details-section{max-height:500px;padding-top:15px}
        .grid-item.is-single.is-expanded .details-section{max-height:100px; padding-top:15px}
        .details-section ul{list-style:none;padding:15px 0 0 0;margin:0;border-top:1px solid #eee}
        .details-section li{padding:8px 0;font-size:14px;color:var(--text-secondary)}
        .details-section .credit-section{padding:15px 0 0 0;margin:0;border-top:1px solid #eee}
        .details-section .credit-item{display:flex;justify-content:space-between;padding:8px 0;font-size:14px}
        .details-section .credit-item .name{font-weight:500;color:var(--text-primary)}
        .view-controls{position:fixed;top:30px;right:100px;z-index:210;display:flex;gap:5px}
        .col-btn{background:#fff;border:1px solid var(--border-color);color:var(--text-primary);width:40px;height:40px;border-radius:50%;cursor:pointer;transition:all .2s ease;font-size:24px;font-weight:500}.col-btn:hover{background:var(--text-primary);color:var(--background-color)}.col-btn:disabled{opacity:0.5;cursor:not-allowed}
        .close-btn{position:fixed;top:30px;right:40px;z-index:210;background:#fff;border:1px solid var(--border-color);color:var(--text-primary);width:40px;height:40px;border-radius:50%;cursor:pointer;transition:all var(--transition-speed) ease;font-family:serif;font-size:24px;line-height:40px;padding:0;text-align:center}.close-btn:hover{background:var(--text-primary);color:var(--background-color);transform:scale(1.05)}
        #sentinel{width:100%;height:50px}
        .error-message{text-align:center;padding:50px;font-size:18px;color:var(--text-secondary)}
    </style>
</head>
<body>
    <div id="intro-overlay">
        <img id="intro-logo" src="https://64.media.tumblr.com/fbaac6c418b3efe867fc896e29c8d863/973a2b545611b06c-91/s1280x1920/3f91e5bd659bcb37148ef07764e633c6212aac19.png" alt="Take A Daytrip Logo">
    </div>

    <div class="site-content">
        <header class="header">
            <div class="logo">
                <img src="https://64.media.tumblr.com/fbaac6c418b3efe867fc896e29c8d863/973a2b545611b06c-91/s1280x1920/3f91e5bd659bcb37148ef07764e633c6212aac19.png" alt="Take A Daytrip Logo">
            </div>
            <button class="view-toggle" id="viewToggle">View All</button>
        </header>
        <main class="carousel-view" id="carouselView">
            <div class="carousel-container" id="carouselContainer">
                 <!-- Carousel items will be injected here -->
            </div>
        </main>
        <div class="index-view" id="indexView">
            <div class="view-controls">
                <button id="minus-btn" class="col-btn">-</button>
                <button id="plus-btn" class="col-btn">+</button>
            </div>
            <button class="close-btn" id="closeBtn">&times;</button>
            <div class="index-grid" id="indexGrid">
                <!-- Grid items will be injected here -->
            </div>
            <div id="sentinel"></div>
        </div>
    </div>

    <script>
        const AIRTABLE_CONFIG = {
            token: 'patGvw0Eizo229tIk.540600d44b40ee31dc5e30e46e1255c4704f3447fc0f67ae7da736a59b40897b',
            baseId: 'appn2YeNc6Sv40xdd',
            tableName: 'Take A Daytrip Discography',
            pageSize: 30
        };
        
        let dataOffset = 'start'; // Use 'start' to signify the first fetch
        let isFetching = false;
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM Loaded. Starting App.");
            try {
                const introOverlay = document.getElementById('intro-overlay');
                setTimeout(() => { introOverlay.classList.add('hidden'); }, 500);
                setTimeout(() => { introOverlay.style.display = 'none'; }, 1500);
                
                await fetchAndRenderReleases(true);

            } catch (error) {
                console.error("Critical initialization failure:", error);
                const mainContent = document.querySelector('.site-content') || document.body;
                mainContent.innerHTML = `<div class="error-message"><h1>Could not load discography</h1><p>Please check the console for details.</p></div>`;
            }
        });

        async function fetchAirtableData(offset = null) {
            // If offset is 'start', we are on the first page and don't need the offset parameter
            let url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${encodeURIComponent(AIRTABLE_CONFIG.tableName)}?pageSize=${AIRTABLE_CONFIG.pageSize}&sort%5B0%5D%5Bfield%5D=Release Date&sort%5B0%5D%5Bdirection%5D=desc`;
            if (offset && offset !== 'start') url += `&offset=${offset}`;

            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${AIRTABLE_CONFIG.token}` } });
            
            if (!response.ok) {
                const errorBody = await response.json();
                console.error("Airtable Error Details:", errorBody);
                throw new Error(`Airtable request failed with status ${response.status}`);
            }
            return response.json();
        }
        
        function mapAirtableRecord(record) {
            const fields = record.fields;
            let credits = null;
            if (fields.Credits) {
                try {
                    // Airtable sometimes returns a string that needs parsing.
                    credits = typeof fields.Credits === 'string' ? JSON.parse(fields.Credits) : fields.Credits;
                } catch (e) {
                    console.warn(`Could not parse Credits JSON for record "${fields.Title}":`, fields.Credits);
                }
            }
            return {
                title: fields.Title || fields.Songs || 'Untitled',
                artist: fields.Artists || 'Unknown Artist',
                type: fields.Type || 'Single',
                releaseDate: fields['Release Date'] || '',
                albumArtUrl: fields.Artwork?.[0]?.url || '',
                tracks: fields.Tracks ? fields.Tracks.split('\n') : [],
                credits: credits,
                videoUrl: fields['Video Link'] || '',
                youtubeUrl: fields['YouTube Link'] || '',
                spotifyUrl: fields['Spotify Link'] || '',
                appleMusicUrl: fields['Apple Music Link'] || '',
                showInCarousel: fields.ShowInCarousel === true
            };
        }

        async function fetchAndRenderReleases(isInitialLoad = false) {
            if (isFetching || dataOffset === null) return;
            isFetching = true;

            try {
                const data = await fetchAirtableData(dataOffset);
                if (!data || !data.records) { 
                    dataOffset = null; // No more data
                    return;
                }

                const newReleases = data.records.map(mapAirtableRecord);
                dataOffset = data.offset || null; // If no offset, we've reached the end

                if (isInitialLoad) {
                    initializeApp(newReleases);
                } else {
                    renderIndex(newReleases, false); // Append new items
                }
            } catch (error) {
                console.error("Failed to fetch and render releases:", error);
                if(isInitialLoad) throw error; // Re-throw for initial load failure
                else { // Handle subsequent load failures gracefully
                    const sentinel = document.getElementById('sentinel');
                    if(sentinel) sentinel.innerHTML = `<p class="error-message">Failed to load more.</p>`;
                }
            } finally {
                isFetching = false;
            }
        }
        
        function initializeApp(initialReleases) {
            renderCarousel(initialReleases.filter(r => r.showInCarousel));
            renderIndex(initialReleases, true); // Initial render
            setupLazyLoader();
            setupStaticUI();
        }

        function renderCarousel(releases) {
            const container = document.getElementById('carouselContainer');
            if (!container) return;
            container.innerHTML = '';
            
            releases.forEach(release => {
                const item = document.createElement('div');
                item.className = 'carousel-item';
                
                let videoHtml = release.videoUrl ? `<video src="${release.videoUrl}" loop muted playsinline></video>` : '';
                let linksHtml = [
                    release.spotifyUrl ? `<a href="${release.spotifyUrl}" target="_blank">Spotify</a>` : '',
                    release.appleMusicUrl ? `<a href="${release.appleMusicUrl}" target="_blank">Apple Music</a>` : '',
                    release.youtubeUrl ? `<a href="${release.youtubeUrl}" target="_blank">YouTube</a>` : ''
                ].filter(Boolean).join('');

                item.innerHTML = `
                    <div class="album-cover" style="background-image: url('${release.albumArtUrl}')">
                        ${videoHtml}
                        <div class="action-overlay">${linksHtml}</div>
                    </div>
                    <div class="item-info">
                        <div class="item-title">${release.title}</div>
                        <div class="item-artist">${release.artist}</div>
                    </div>
                `;
                container.appendChild(item);

                // "Living Album Art" logic
                let hoverTimeout;
                item.addEventListener('mouseenter', () => {
                    item.classList.add('is-active');
                    if (release.videoUrl) {
                        hoverTimeout = setTimeout(() => {
                            item.classList.add('is-expanded');
                            const video = item.querySelector('video');
                            if (video) video.play();
                        }, 1500);
                    }
                });
                item.addEventListener('mouseleave', () => {
                    clearTimeout(hoverTimeout);
                    item.classList.remove('is-active', 'is-expanded');
                    const video = item.querySelector('video');
                    if (video) video.pause();
                });
            });
        }

        function renderIndex(releases, isInitialRender = false) {
            const grid = document.getElementById('indexGrid');
            if(!grid) return;
            if (isInitialRender) grid.innerHTML = '';

            releases.forEach(release => {
                const item = document.createElement('div');
                item.className = `grid-item ${release.type === 'Album' ? 'is-album' : 'is-single'}`;
                
                let detailsHtml = '';
                if (release.type === 'Album' && release.tracks.length > 0) {
                    detailsHtml = `<ul>${release.tracks.map(track => `<li>${track}</li>`).join('')}</ul>`;
                } else if (release.type === 'Single' && release.credits) {
                    const creditsList = Object.entries(release.credits).map(([key, value]) => 
                        `<div class="credit-item"><span class="role">${key}</span><span class="name">${value}</span></div>`
                    ).join('');
                    detailsHtml = `<div class="credit-section">${creditsList}</div>`;
                }

                item.innerHTML = `
                    <div class="item-header">
                        <div class="item-thumbnail" style="background-image: url('${release.albumArtUrl}')"></div>
                        <div class="item-details">
                            <div class="title">${release.title}</div>
                            <div class="artist">${release.artist}</div>
                        </div>
                    </div>
                    <div class="details-section">${detailsHtml}</div>
                `;
                grid.appendChild(item);

                item.addEventListener('click', () => {
                    const alreadyExpanded = item.classList.contains('is-expanded');
                    document.querySelectorAll('.grid-item.is-expanded').forEach(el => el.classList.remove('is-expanded'));
                    if (!alreadyExpanded) {
                        item.classList.add('is-expanded');
                    }
                });
            });
        }

        function setupLazyLoader() {
            const sentinel = document.getElementById('sentinel');
            if (!sentinel) return;

            const observer = new IntersectionObserver(entries => {
                if (entries[0].isIntersecting && !isFetching && dataOffset) {
                    fetchAndRenderReleases();
                }
            }, { threshold: 1.0 });

            observer.observe(sentinel);
        }

        function setupStaticUI() {
            const viewToggle = document.getElementById('viewToggle');
            const closeBtn = document.getElementById('closeBtn');
            const indexView = document.getElementById('indexView');
            
            viewToggle.addEventListener('click', () => indexView.classList.add('active'));
            closeBtn.addEventListener('click', () => indexView.classList.remove('active'));

            // Column controls
            const plusBtn = document.getElementById('plus-btn');
            const minusBtn = document.getElementById('minus-btn');
            const indexGrid = document.getElementById('indexGrid');
            let columns = 4;

            const updateGridColumns = () => {
                indexGrid.style.setProperty('--grid-columns', columns);
                const newSize = 240 - (columns * 20);
                indexGrid.style.setProperty('--thumbnail-size', `${Math.max(60, newSize)}px`);
                minusBtn.disabled = columns <= 2;
                plusBtn.disabled = columns >= 6;
            };

            plusBtn.addEventListener('click', () => {
                if (columns < 6) { columns++; updateGridColumns(); }
            });

            minusBtn.addEventListener('click', () => {
                if (columns > 2) { columns--; updateGridColumns(); }
            });
            updateGridColumns();
        }
    </script>
</body>
</html>
